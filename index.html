<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>見積書作成ツール</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- JavaScriptファイルを正しい順序で読み込む -->
    <script src="js/storage.js"></script>
    <script src="js/calculation.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/pdf-generator.js"></script>
    <script src="js/main.js"></script>
</head>
<body>
    <header>
        <h1>見積書作成ツール</h1>
        <div class="version">Version 1.0</div>
    </header>
    
    <main>
        <!-- タブナビゲーション -->
        <div class="tab-nav">
            <button class="tab active" data-tab="estimate">見積入力</button>
            <button class="tab" data-tab="preview">プレビュー</button>
            <button class="tab" data-tab="settings">設定</button>
        </div>
        
        <!-- 見積入力タブ -->
        <div id="estimateTab" class="tab-content active">
            <form id="estimateForm">
                <!-- 基本情報 -->
                <div class="form-section">
                    <h2>基本情報</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="estimateNumber">見積番号</label>
                            <input type="text" id="estimateNumber" name="estimateNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="estimateDate">見積日</label>
                            <input type="date" id="estimateDate" name="estimateDate" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="client">見積提出先</label>
                            <input type="text" id="client" name="client" required>
                        </div>
                        <div class="form-group">
                            <label for="project">件名</label>
                            <input type="text" id="project" name="project" required>
                        </div>
                    </div>
                </div>
                
                <!-- 明細入力 -->
                <div class="form-section">
                    <h2>明細入力</h2>
                    <div class="table-responsive">
                        <table id="itemTable" class="item-table">
                            <thead>
                                <tr>
                                    <th>摘要</th>
                                    <th>数量</th>
                                    <th>単位</th>
                                    <th>原価</th>
                                    <th>掛け率</th>
                                    <th>金額</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="itemTableBody">
                                <tr>
                                    <td><input type="text" name="description[]" placeholder="摘要"></td>
                                    <td><input type="number" name="quantity[]" min="0" step="0.01" value="1"></td>
                                    <td>
                                        <select name="unit[]">
                                            <option value="式">式</option>
                                            <option value="個">個</option>
                                            <option value="時間">時間</option>
                                            <option value="日">日</option>
                                            <option value="本">本</option>
                                            <option value="ヶ月">ヶ月</option>
                                        </select>
                                    </td>
                                    <td><input type="number" name="cost[]" min="0" step="1" value="0"></td>
                                    <td><input type="number" name="markupRate[]" min="0" step="0.01" value="1"></td>
                                    <td><input type="text" name="amount[]" readonly></td>
                                    <td><button type="button" class="delete-row-btn">×</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <button type="button" id="addRowBtn" class="btn-secondary">明細行を追加</button>
                    
                    <!-- 合計欄 -->
                    <div class="totals">
                        <div class="total-row">
                            <div class="total-label">小計</div>
                            <div id="subtotal" class="total-value">¥0</div>
                        </div>
                        <div class="total-row">
                            <div class="total-label">消費税 (10%)</div>
                            <div id="tax" class="total-value">¥0</div>
                        </div>
                        <div class="total-row grand-total">
                            <div class="total-label">合計</div>
                            <div id="total" class="total-value">¥0</div>
                        </div>
                    </div>
                </div>
                
                <!-- ボタン -->
                <div class="form-actions">
                    <button type="submit" id="calculateBtn" class="btn-primary">計算する</button>
                    <button type="button" id="previewBtn" class="btn-secondary">プレビュー</button>
                    <button type="button" id="downloadBtn" class="btn-secondary">PDFダウンロード</button>
                    <button type="button" id="printBtn" class="btn-secondary">印刷</button>
                </div>
            </form>
            
            <!-- 計算結果 -->
            <div id="estimateResult" class="result-card hidden">
                <h2>計算結果</h2>
                <div class="result-row">
                    <div class="result-label">見積小計:</div>
                    <div id="resultSubtotal" class="result-value">¥0</div>
                </div>
                <div class="result-row">
                    <div class="result-label">見積合計:</div>
                    <div id="resultTotal" class="result-value">¥0</div>
                </div>
                <div class="result-row">
                    <div class="result-label">原価合計:</div>
                    <div id="resultTotalCost" class="result-value">¥0</div>
                </div>
                <div class="result-row">
                    <div class="result-label">粗利率:</div>
                    <div id="resultGrossMarginPercent" class="result-value">0%</div>
                </div>
            </div>
        </div>
        
        <!-- プレビュータブ -->
        <div id="previewTab" class="tab-content">
            <div id="previewContainer" class="preview-container">
                <div id="pdfContent" class="pdf-content">
                    <div id="pdfEstimateSheet" class="estimate-sheet">
                        <!-- ここにプレビューコンテンツが動的に生成される -->
                    </div>
                </div>
            </div>
            <div id="previewButtons" class="preview-actions">
                <button type="button" id="previewDownloadBtn" class="btn-primary">PDFダウンロード</button>
                <button type="button" id="previewPrintBtn" class="btn-secondary">印刷</button>
            </div>
        </div>
        
        <!-- 設定タブ -->
        <div id="settingsTab" class="tab-content">
            <form id="companySettingsForm">
                <div class="form-section">
                    <h2>会社情報設定</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyName">会社名</label>
                            <input type="text" id="companyName" name="companyName">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyPostal">郵便番号</label>
                            <input type="text" id="companyPostal" name="companyPostal" placeholder="例: 123-4567">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyAddress">住所</label>
                            <input type="text" id="companyAddress" name="companyAddress">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyPhone">電話番号</label>
                            <input type="text" id="companyPhone" name="companyPhone" placeholder="例: 03-1234-5678">
                        </div>
                        <div class="form-group">
                            <label for="companyFax">FAX番号</label>
                            <input type="text" id="companyFax" name="companyFax" placeholder="例: 03-1234-5679">
                        </div>
                    </div>
                    
                    <!-- 画像アップロード -->
                    <div class="form-row">
                        <div class="form-group image-upload">
                            <label>会社ロゴ</label>
                            <div class="image-preview-container">
                                <img id="companyLogoPreview" class="image-preview" style="display: none;">
                                <button type="button" id="removeLogoBtn" class="remove-image-btn" style="display: none;">削除</button>
                            </div>
                            <input type="file" id="companyLogo" accept="image/*">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group image-upload">
                            <label>社印</label>
                            <div class="image-preview-container">
                                <img id="companyStampPreview" class="image-preview" style="display: none;">
                                <button type="button" id="removeStampBtn" class="remove-image-btn" style="display: none;">削除</button>
                            </div>
                            <input type="file" id="companyStamp" accept="image/*">
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
            
            <!-- デバッグとシステム設定 -->
            <div class="form-section system-settings">
                <h2>システム設定</h2>
                <div class="form-row">
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="debugMode">
                        <label for="debugMode">デバッグモード</label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="pdfTimeout">PDF生成タイムアウト値（秒）</label>
                        <input type="number" id="pdfTimeout" min="5" max="120" value="15">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <button type="button" id="clearStorageBtn" class="btn-danger">全設定をリセット</button>
                    </div>
                </div>
                <div id="storageWarning" class="warning hidden">
                    <strong>注意:</strong> ローカルストレージが利用できないため、設定が保存されません。
                </div>
            </div>
            
            <!-- デバッグパネル -->
            <div id="debugPanel" class="debug-panel" style="display: none;">
                <h3>デバッグ情報</h3>
                <div id="debugLogs" class="debug-logs"></div>
            </div>
        </div>
    </main>
    
    <!-- ローディングスピナー -->
    <div id="loadingSpinner" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="spinner-text">PDFを生成中...</div>
            <div id="spinnerActions" class="spinner-actions">
                <button type="button" id="cancelPdfBtn" class="btn-secondary">キャンセル</button>
                <button type="button" id="alternativePdfBtn" class="btn-link">代わりに印刷する</button>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="copyright">© <span id="copyrightYear">2024</span> 見積書作成ツール</div>
    </footer>

    <!-- デバッグ情報表示 -->
<script>
    window.addEventListener('load', function() {
        console.log('--- デバッグ情報 ---');
        console.log('DEFAULT_TIMEOUT defined:', typeof window.DEFAULT_TIMEOUT !== 'undefined');
        console.log('DEBUG_KEY defined:', typeof window.DEBUG_KEY !== 'undefined');
        console.log('checkStorage function defined:', typeof window.checkStorage === 'function');
        console.log('loadSettings function defined:', typeof window.loadSettings === 'function');
        console.log('updateAmounts function defined:', typeof window.updateAmounts === 'function');
        console.log('calculateEstimate function defined:', typeof window.calculateEstimate === 'function');
        console.log('switchTab function defined:', typeof window.switchTab === 'function');
        console.log('generatePDF function defined:', typeof window.generatePDF === 'function');
    });
</script>
</body>
</html>
